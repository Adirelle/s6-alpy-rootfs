#!/bin/execlineb -P
define BASE /etc/s6-rc

getpid N
backtick -n PREV { readlink ${BASE}/compiled }

multisubstitute {
	import -u N
	import -u PREV
}

define NEW ${BASE}/compiled.${N}

if { s6-rc-compile ${NEW} ${BASE}/source }
foreground { ln -snf ${NEW} ${BASE}/compiled }
echo ${NEW}

