#!/bin/execlineb -S0

/bin/export PATH /bin:/usr/bin:/sbin:/usr/sbin
cd /
if { s6-echo "\n  initramfs (minimal)\n" }

define ROOTDIR /newroot

ifte -X {
	switch_root $ROOTDIR /sbin/init $@
} {
	foreground { s6-echo "Something went very wrong. Falling back to a shell. Good luck !" }
	foreground { /bin/busybox --install /bin }
	/bin/ash -i
}

if { s6-mount -wt proc -o nosuid,noexec,nodev proc /proc }
if { s6-mount -wt sysfs -o nosuid,noexec,nodev sysfs /sys }
if { s6-mount -wt devtmpfs -o nosuid,noexec devtmpfs /dev }

if {
	importas -sd, MODULES modules
	modprobe -a $MODULES
}

if { redirfd -w 1 /proc/sys/kernel/hotplug s6-echo /sbin/mdev }
if { /sbin/mdev -s }
if { redirfd -w 1 /proc/sys/kernel/hotplug s6-echo }

define ROOTFS /dev/sda2
define ROOTFSTYPE ext4

if { modprobe $ROOTFSTYPE }

if { s6-mount -rt $ROOTFSTYPE $ROOTFS $ROOTDIR }

if { s6-mount -o move /sys ${ROOTDIR}/sys }
if { s6-mount -o move /proc ${ROOTDIR}/proc }
s6-mount -o move /dev ${ROOTDIR}/dev
